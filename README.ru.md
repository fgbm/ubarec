![Pypi version](https://img.shields.io/pypi/v/ubarec.svg)
![Python versions](https://img.shields.io/pypi/pyversions/ubarec)
![build](https://github.com/fgbm/ubarec/workflows/build/badge.svg)
![License](https://img.shields.io/github/license/fgbm/ubarec.svg)
![Downloads](https://img.shields.io/pypi/dm/ubarec)

# Ubarec

[English](https://github.com/fgbm/ubarec/blob/master/README.md)

Утилита предназначена для резервного копирования и восстановления баз данных на S3 хранилища. 
Пока что поддерживаются базы данных PostgreSQL и MS SQL.

## Установка

### Ubuntu

Основные зависимости и пакет устанавливаются легко:
```bash
sudo apt install -y p7zip-full unixodbc-dev python3.8 python3-pip && python3.8 -m pip install ubarec
```

При работе с MS SQL необходимо установить соответствующий [драйвер ODBC](https://docs.microsoft.com/sql/connect/odbc/linux-mac/installing-the-microsoft-odbc-driver-for-sql-server).

### Windows

В программе используется консольный архиватор [7-Zip](https://www.7-zip.org/download.html), 
который необходимо предварительно установить любым удобным способом, например, при помощи
пакетного менеджера [chocolatey](https://chocolatey.org/):
```powershell
choco install 7zip 
```

Установка модуля производится из окружения с правами администратора:
```powershell
py -m pip install ubarec
```
## Принцип работы

В режиме резервного копирования Ubarec выполняет следующие действия для каждой из указанных в параметрах командной строки базы данных:
- формирует дамп БД (либо посредством выполнения SQL-скрипта, либо используя стандартные утилиты)
- архивирует дамп при помощи 7zip, если опередена переменная окружения `UBAREC_ZIP_PASSWORD`, то архив защищается паролем
- созданный архив копируется в S3-хранилище
- созданные файлы на предыдущих этапах удаляются

Формируемый архив БД имеет имя файла по маске:

```<Текущее имя хоста>__<Имя БД>__<Временная метка>.zip```

В режиме восстановления Ubarec выполняет следующий алгоритм:
- производит поиск последнего архива указанной БД в S3 хранилище
- копирует найденный архив во временную папку
- распаковывает архив, используя пароль `UBAREC_ZIP_PASSWORD`
- если указан ключ `do_restore`, то производит лперацию восстановления БД в СУБД либо посредством выполнения SQL-скрипта, либо используя стандартные утилиты (в зависимости от типа СУБД)
- удалаяет созданные файлы на предыдущих этапах, если указан ключ `do_restore`, то дамп БД остаётся

## Настройка

В соответствии с принципами [12-факторного приложения](https://12factor.net/ru/), 
настройки Ubarec берёт из переменных окружения.

| Наименование переменной  | Обязательно? | Значение по умолчанию                       | Описание                                                  |
| ------------------------ | ------------ | ------------------------------------------- | --------------------------------------------------------- |
| `UBAREC_ENDPOINT_URL`    | Нет          | `https://storage.yandexcloud.net`           | Точка входа объектного хранилища S3                       |
| `UBAREC_REGION_NAME`     | Нет          | `ru-central1`                               | Наименование региона                                      |
| `UBAREC_ACCESS_KEY`      | Да           |                                             | Идентификатор ключа для доступа к бакету                  |
| `UBAREC_SECRET_KEY`      | Да           |                                             | Секретная часть ключа для доступа к бакету                |
| `UBAREC_BUCKET_NAME`     | Да           |                                             | Наименование бакета                                       |
| `UBAREC_ZIP_PASSWORD`    | Нет          |                                             | Пароль на ZIP-архив                                       |
| `UBAREC_DB_TYPE`         | Нет          | `mssql`                                     | Тип базы данных ('mssql' или 'postgres')                  |
| `UBAREC_DB_HOST`         | Нет          | `localhost`                                 | Сервер баз данных                                         |
| `UBAREC_DB_PORT`         | Нет          |                                             | Порт подключения к базе данных                            |
| `UBAREC_DB_USERNAME`     | Да           |                                             | Имя пользователя для подключения к БД                     |
| `UBAREC_DB_PASSWORD`     | Да           |                                             | Пароль для подключения к БД                               |
| `UBAREC_DB_DRIVER`       | Нет          |                                             | Драйвер ODBC для подключения к БД (используетя для MSSQL) |
| `UBAREC_TEMP_PATH`       | Нет          | Пользовательское хранилище временных файлов | Путь для хранения временных файлов                        |
| `UBAREC_LOG_PATH`        | Нет          |                                             | Путь для хранения логов                                   |
| `UBAREC_DEBUG`           | Нет          | `False`                                     | Режим отладки                                             |
| `UBAREC_FILENAME_PREFIX` | Нет          | `{hostname}__{backup_name}__`               | Префикс имени файла, загружаемого на S3 хранилище         |

## Резервное копирование

```powershell
ubarec backup --help
```
TODO: Описать алгоритм бекапа, ключи запуска

## Восстановление из резервной копии

```powershell
ubarec restore --help
```
TODO: Описать алгоритм восстановления, ключи запуска
